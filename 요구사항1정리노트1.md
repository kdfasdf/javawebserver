## 요구사항 1-1 - http://localhost:8080/index.html로 접속시 응답

웹에서 클라이언트가 주소창에 특정 도메인이나 IP를 입력하면  특정 도메인에 대응되는 IP주소를 찾아
특정 서버와 브라우저를 연결한다.
만약 주소창에 http://임의의이름/index.html을 치면 아래 같은 http 요청 메시지를 보내게 된다

- http 요청 메시지
  - header
    <br>
  
    ```
    GET /index.html HTTP/1.1
    HOST 임의의 이름
    Connection: keep-alive
    Accept : */*
    ...
    ```
  - body
    - 없음

  <br>
  
클라이언트는 해당 요청에 대한 응답을 서버로 부터 받는다
- http 응답 메시지
  - header
    <br>
    ```
    HTTP 1.1 200 OK
    Last - modified : ....
    content - length : ...
    content type : text/html
    ...
    ```
  - body
    ```
    <HTML>
    ...
    </HTML>
    ```
    
![image](https://github.com/kdfasdf/javawebserver/assets/96770726/dd489473-22d0-4cc2-b37b-6c200b0b43be)

1. 해당 요구사항에 대해서 동작을 수행하는 코드는 Webserver.java와 RequestHandler.java이다.
2. 실행할 때 매개변수로 받은 숫자가 있다면 그 숫자를 포트번호로 사용하고 아니면 8080을 기본 포트로 사용한다
3. WebServer에서 클라이언트와 연결될 때 까지 기다렸다가 연결 되면 requestHandler를 통해 클라이언트로 응답을 보낸다
4. localhost/index.html에서 index.html을 얻는 코드는 HttpRequestUtils에 getUrl메서드를 구현 하였다.
- WebServer.java
```
package webserver;

import org.slf4j.LoggerFactory;
import org.slf4j.Logger;

import java.net.ServerSocket;
import java.net.Socket;

public class WebServer {
    private static final Logger log = LoggerFactory.getLogger(WebServer.class);
    public static final int DEFAULT_PORT=8080;
    public static void main(String args[]) throws Exception{
        int port =0;
        if(args==null||args.length==0){ //실행 시 매개변수가 없으면
            port=DEFAULT_PORT;
        }
        else{
            port=Integer.parseInt(args[0]);  //실행 시 매개변수가 있는 경우
        }
        try(ServerSocket listenSocket = new ServerSocket(port)){
            log.info("Web Application Server started {} port",port);
            Socket connection;

            // 클라이언트와 서버가 연결될 때 까지 기다리고
            // 연결되면 IP주소를 매개변수로 RequestHandler로 동작한다.
            while((connection = listenSocket.accept())!=null){
                RequestHandler requestHandler=new RequestHandler(connection);
                requestHandler.start();
            }
        }

    }
}
```

- RequestHandler.java
```
package webserver;

import java.io.*;
import java.net.Socket;
import java.nio.file.Files;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import util.HttpRequestUtils;

public class RequestHandler extends Thread {
    private static final Logger log = LoggerFactory.getLogger(RequestHandler.class);

    private Socket connection;

    public RequestHandler(Socket connectionSocket) {
        this.connection = connectionSocket;
    }

    public void run() {
        log.debug("New Client Connect! Connected IP : {}, Port : {}", connection.getInetAddress(),
                connection.getPort());
        try (InputStream in = connection.getInputStream(); OutputStream out = connection.getOutputStream()) {
            InputStreamReader isr = new InputStreamReader(in,"UTF-8");
            BufferedReader br = new BufferedReader(isr);
            String url = HttpRequestUtils.getUrl(br.readLine());
            DataOutputStream dos = new DataOutputStream(out);
            byte[] body = Files.readAllBytes(new File("./webapp"+url).toPath());
            response200Header(dos, body.length);
            responseBody(dos, body);
        } catch (IOException e) {
            log.error(e.getMessage());
        }
    }

    private void response200Header(DataOutputStream dos, int lengthOfBodyContent) {
        try {
            dos.writeBytes("HTTP/1.1 200 OK \r\n");
            dos.writeBytes("Content-Type: text/html;charset=utf-8\r\n");
            dos.writeBytes("Content-Length: " + lengthOfBodyContent + "\r\n");
            dos.writeBytes("\r\n");
        } catch (IOException e) {
            log.error(e.getMessage());
        }
    }

    private void responseBody(DataOutputStream dos, byte[] body) {
        try {
            dos.write(body, 0, body.length);
            dos.flush();
        } catch (IOException e) {
            log.error(e.getMessage());
        }
    }
}

```

- HttpRequestUtils.java
```
package util;

import java.util.stream.Collectors;

import com.google.common.base.Strings;
import com.google.common.collect.Maps;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class HttpRequestUtils {
    public static final Logger log = LoggerFactory.getLogger(HttpRequestUtils.class);
    public static String getUrl(String firstLine){
        String [] splited = firstLine.split(" ");
        String path = splited[1];
        log.debug("request path : {}",path);
        return path;
    }
   
        @Override
        public String toString() {
            return "Pair [key=" + key + ", value=" + value + "]";
        }
    }
}

```

※ Util 클래스란?
여러 클래스에서 공통적으로 사용되는 메서드를 모아서 클래스로 만드는 것

## 요구사항 1-2  GET 방식으로 회원가입 하기 단 db 연동을 안하므로 응답은 302 status code
- http://localhost:8080/user/form.html에서 회원가입을 한다. 회원가입 폼에 넣은 사용자 정보는 model.User클래스에 저장한다
- 회원 가입을 완료하면 /user/create로 넘어가게 된다. 하지만 /user/create/에 대해서는 응답으로 전달할 파일이 없기 때문에 /index.html 페이지로 이동한다.

![image](https://github.com/kdfasdf/javawebserver/assets/96770726/f1f53c40-e583-4627-8904-512178077d26)


http://localhost:8080/user/form.html 에서 회원가입 폼에 사용자 정보를 입력하고 전송을 누르면
GET 방식으로 http 요청이 만들어진다.

```
GET /user/create?userID=testID&password=testPW&name=testName&email=test%40test HTTP/1.1
```

? 뒤에 오는 사용자 정보는 추출하여 model.User 클래스에 저장한다 <br>

그리고 HTTP 요청을 보면 알겠지만 우선 /user/create가 있는지 찾아야 한다. 하지만 /user/create로는 응답할 페이지가 없기 때문에 
리다이렉트 하는 코드를 작성해주어야 한다 리다이렉트 하는 상황에 대한 302 헤더도 클라이언트로 보내야 한다. 해당 부분은 RequestHandler.java에서 구현해주었다

- RequestHandler.java
```
package webserver;

import model.User;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import util.HttpRequestUtils;

import java.io.*;
import java.net.Socket;
import java.nio.file.Files;
import java.nio.file.Paths;

public class RequestHandler extends Thread{
    private static final Logger log = LoggerFactory.getLogger(RequestHandler.class);
    private Socket connection;
    public RequestHandler(Socket connectionSocket){
        this.connection=connectionSocket;
    }

    @Override
    public void run(){
        log.debug("New Client Connect! Connected IP {}, PORT : {}",connection.getInetAddress(),connection.getPort());
        try(InputStream in = connection.getInputStream();
            OutputStream out = connection.getOutputStream())
        {
            InputStreamReader isr = new InputStreamReader(in,"UTF-8");
            BufferedReader br = new BufferedReader(isr);
            String url = HttpRequestUtils.getUrl(br.readLine());
            int index = url.indexOf("?");              //url 유저정보 파라미터를 분리하기 위해 ?의 인덱스를 저장한다
            String requestPath;
            String defaultPath="/index.html";        //redirect 할 defaultPath로 index.html
            String params;
            if (index==-1){                //indexOf는 해당 문자에 대한 index를 찾을 수 없으면 -1을 반환한다
             requestPath=url;
             params="";
            }
            else {
                requestPath = url.substring(0, index);    //? 앞부분 추출 즉 /user/create
                params = url.substring(index + 1);
            }
            DataOutputStream dos = new DataOutputStream(out);
            if (Files.exists( Paths.get("./webapp"+requestPath))){ //요청한 웹페이지에 해당하는 파일이 있다면
            byte[] body = Files.readAllBytes(new File("./webapp"+requestPath).toPath());
            urlFunction(requestPath,dos,params,body);    //웹 url에 따라 다른 기능을 수행하기 위함
            }
            else{                                         //없는 경우 기본 페이지인 index.html 페이지를 응답으로 보낸다
                log.debug("defaultPath{}",defaultPath);
            byte[] body = Files.readAllBytes(new File("./webapp"+defaultPath).toPath());
            urlFunction(requestPath, dos, params, body);
             }
            } catch(Exception e){
            e.printStackTrace();

        }
    }
    private void response200Header(DataOutputStream dos, int lengthOfBodyContent) {
        try {
            dos.writeBytes("HTTP/1.1 200 OK \r\n");
            dos.writeBytes("Content-Type: text/html;charset=utf-8\r\n");
            dos.writeBytes("Content-Length: " + lengthOfBodyContent + "\r\n");
            dos.writeBytes("\r\n");// 웹은 헤더와 body를 구분할 때 \r\n\r\n로 구분함
        } catch (IOException e) {
            log.error(e.getMessage());
        }
    }

    private void response302Header(DataOutputStream dos, int lengthOfBodyContent) {
        try {
            dos.writeBytes("Http/1.1 302 OK \r\n");
            dos.writeBytes("Content-Type: text/html;charset=utf-8\r\n");
            dos.writeBytes("Content-Length: "+lengthOfBodyContent+"\r\n");
            dos.writeBytes("\r\n");
        }catch(IOException e){
            log.error(e.getMessage());
        }
    }
    private void responseBody(DataOutputStream dos, byte[] body) {
        try {
            dos.write(body, 0, body.length);
            dos.flush();
        } catch (IOException e) {
            log.error(e.getMessage());
        }
    }

    private void urlFunction(String requestPath, DataOutputStream dos, String params, byte[] body){
        if("/user/create".equals(requestPath)) {    
            if (params==null) {
                response302Header(dos, body.length);
                responseBody(dos, body);
            }
            else{
                String[] info=params.split("&");
                String[] acc = new String[4];
                for(int i=0; i<info.length;i++){
                    String[] value = info[i].split("=");
                    acc[i]=value[1];
                }
                User user = new User(acc[0],acc[1],acc[2],acc[3]);
                response302Header(dos,body.length);
                responseBody(dos, body);
            }
        }
        else{
            response200Header(dos, body.length);
            responseBody(dos, body);
        }
    }
}
```
